// $(function(){
function setYMax(e){y.domain([e,0]),x.domain([0,101]),renderAxes()}function renderAxes(){d3.event&&d3.event.transform(x,y);var e=x.tickFormat(10),t=y.tickFormat(10),n=xTicks.selectAll("g.x").data(x.ticks(5),String).attr("transform",tx);n.select("text").text(e);var r=n.enter().insert("g","a").attr("class","x").attr("transform",tx);r.append("line").attr("stroke",stroke).attr("y1",0).attr("y2",size[1]),r.append("text").attr("y",size[1]).attr("dy","1em").attr("text-anchor","middle").text(e),n.exit().remove();var i=yTicks.selectAll("g.y").data(y.ticks(11),String).attr("transform",ty);i.select("text").text(t);var s=i.enter().insert("g","a").attr("class","y").attr("transform",ty);s.append("line").attr("stroke",stroke).attr("x1",0).attr("x2",size[0]),s.append("text").attr("x",-3).attr("dy",".35em").attr("text-anchor","end").text(t),i.exit().remove(),unhighlight(),renderedData&&renderData(renderedData)}function dataLoaded(e){allData=e;var t=d3.max(e.Films,function(e){return e.WorldwideGross});updateSliderMax(t),showYear(2011),addPopovers(e.Stories)}function renderData(e){renderedData=e,e=e.filter(function(e){return e.RottenTomatoes<x.domain()[1]&&e.RottenTomatoes>x.domain()[0]}).filter(function(e){return e.Profitability<y.domain()[0]&&e.Profitability>y.domain()[1]});var t=bubbleG.selectAll("circle").data(e,function(e){return e.Film});t.enter().append("circle").attr("class","film").attr("fill",storyColour),t.attr("cx",function(e){return x(e.RottenTomatoes)}).attr("cy",function(e){return y(e.Profitability)}).on("mouseover",showTooltip).on("mouseout",hideTooltip).attr("r",function(e){return b(e.WorldwideGross)*1.5}),t.exit().attr("r",0).remove()}function showTooltip(e,t){var n=d3.select(this).attr("class","film highlight");n.style("fill-opacity",1),bubbleG.node().appendChild(n.node()),svg.selectAll("circle.film:not(.highlight)").style("fill-opacity",.1);var r=svg.selectAll("text.film-tooltip").data([e],function(e){return e.Film});d3.select("#film-name").text(e.Film),d3.select("#film-year").text(e.Year),d3.select("#film-genre").text(e.Genre),d3.select("#film-story").text(e.Story),d3.select("#film-rating").text(e.RottenTomatoes+"%"),d3.select("#film-profitability").text(e.Profitability+"%"),d3.select("#film-gross").text("$"+e.WorldwideGross+"m"),d3.select("#film-budget").text("$"+e.Budget+"m");var i=e.RottenTomatoes>65;r.enter().append("text").attr("class","film-tooltip").style("text-anchor",i?"end":"start").attr("x",parseFloat(n.attr("cx"))+parseFloat(n.attr("r")*(i?-1:1))).attr("y",parseFloat(n.attr("cy"))+3).text(e.Film)}function hideTooltip(e,t){hideAllTooltips(),d3.selectAll("circle").style("fill-opacity",.8).attr("class","film"),d3.selectAll(".film-datum").text("..."),d3.select("#film-name").text("Pick a bubble")}function hideAllTooltips(){svg.selectAll("text.film-tooltip").transition().duration(150).style("opacity",0).remove()}function highlightYear(e){var t=d3.selectAll(".film").filter(function(t){return t.Year==e});highlightSelection(t)}function highlightStories(e){var t=d3.selectAll(".film").filter(function(t){return t.Story.toLowerCase()==e.toLowerCase()});highlightSelection(t)}function highlightSelection(e){e.attr("class","film highlight").transition().duration(150).style("fill-opacity",1);for(var t=0;t<e[0].length;t++)bubbleG.node().appendChild(e[0][t]);svg.selectAll("circle.film:not(.highlight)").transition().duration(150).style("fill-opacity",.1);var n=svg.selectAll("text.film-tooltip").data(e[0],function(e){return e.__data__.Film}),r;n.enter().append("text").attr("class","film-tooltip").style("text-anchor",function(e){return r=e.__data__.RottenTomatoes>65,r?"end":"start"}).attr("x",function(e){return r=e.__data__.RottenTomatoes>65,parseFloat(d3.select(e).attr("cx"))+parseFloat(b(e.__data__.WorldwideGross)*1.5)*(r?-1:1)}).attr("y",function(e){return parseFloat(d3.select(e).attr("cy"))+3}).text(function(e){return e.__data__.Film}).transition().duration(250).style("opacity",1)}function reverseCircleOrder(){var e=d3.selectAll("circle");for(var t=e[0].length-1;t>0;t--)bubbleG.node().appendChild(e[0][t])}function unhighlight(){d3.selectAll("circle.film").transition().duration(150).style("fill-opacity",.8).attr("class","film"),hideAllTooltips()}function removeAllFilms(){renderData([])}function showStories(e){var t=allData.Films.filter(function(t){return e.indexOf(t.Story.toLowerCase())!=-1});renderData(t)}function showYear(e){var t=allData.Films.filter(function(t){return t.Year==e}).sort(function(e,t){return t.WorldwideGross-e.WorldwideGross});renderData(t)}function showYears(e){var t=allData.Films.filter(function(t){return e.indexOf(t.Year)!=-1}).sort(function(e,t){return t.WorldwideGross-e.WorldwideGross});renderData(t)}function showFiltered(e,t,n){var r=allData.Films.filter(function(t){return e.indexOf(t.Year)!=-1}).filter(function(e){return e.WorldwideGross>=n[0]&&e.WorldwideGross<=n[1]}).filter(function(e){return t.indexOf(e.Story.toLowerCase())!=-1}).sort(function(e,t){return t.WorldwideGross-e.WorldwideGross});renderData(r)}var svgSize=[600,730],padding=[4,10,40,55],size=[svgSize[0]-padding[1]-padding[3],svgSize[1]-padding[0]-padding[2]],tx=function(e){return"translate("+x(e)+",0)"},ty=function(e){return"translate(0,"+y(e)+")"},stroke=function(e){return e?"#ccc":"transparent"},renderedData,x=d3.scale.linear().domain([0,101]).range([0,size[0]]),y=d3.scale.pow().exponent(.25).domain([7e3,0]).range([0,size[1]]),b=d3.scale.pow().exponent(.2).domain([.005,2e3]).range([4,15]),storyColour=function(e){return"#"+allData.Stories[e.Story].Colour},svg=d3.select("div#graph").append("svg").attr("width",size[0]+padding[3]+padding[1]).attr("height",size[1]+padding[0]+padding[2]).attr("pointer-events","all").append("g").attr("transform","translate("+padding[3]+","+padding[0]+")").call(d3.behavior.zoom().extent([[0,size[0]],[0,size[1]],[0,1.5]]).on("zoom",renderAxes));svg.append("rect").attr("width",size[0]).attr("height",size[1]).attr("stroke","none").style("fill","transparent"),svg.append("text").attr("class","xLabel").attr("x",size[0]/2).attr("y",svgSize[1]).attr("dy","-1em").attr("text-anchor","middle").text("Rotten Tomatoes Score (%)"),svg.append("text").attr("class","yLabel").attr("x",-padding[3]+10).attr("y",svgSize[0]/2).attr("transform","rotate(-90, "+(-padding[3]+10)+", "+svgSize[0]/2+")").text("Profitability (%)");var xTicks=svg.append("g").attr("class","xTicks"),yTicks=svg.append("g").attr("class","yTicks"),bubbleG=svg.append("g").attr("class","bubbles");renderAxes(),d3.json("data/data.json",dataLoaded);